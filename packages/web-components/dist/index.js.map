{"version":3,"sources":["../src/index.ts","../src/utils/register.js"],"sourcesContent":["import { initializeComponents, html } from \"@agc-system/core\";\nimport { h } from \"preact\";\nimport register from \"./utils/register\";\n\n\nfunction extractKeysFromFunctionArgs(functionString: string): string[] {\n  const regex = /\\(\\{\\s*([^}]*)\\s*\\}\\)/;\n\n  const match = functionString.match(regex);\n\n  if (match) {\n    const destructuredContent = match[1]; \n\n    const keys = destructuredContent\n      .split(\",\") \n      .map((key) => key.trim().split(\"=\")[0].trim()) \n      .filter((key) => key && !key.startsWith(\"...\") && key !== \"children\"); \n\n    return keys;\n  }\n\n  return [];\n}\n\n\n\nfunction createComponent<P>(\n  renderFunction: (props: P) => ReturnType<typeof html>,\n  sheet?: any\n): (props: P) => ReturnType<typeof html> {\n  return (props: P) => {\n\n\n  if (typeof window !== \"undefined\" && typeof customElements !== \"undefined\") {\n\n    const observedAttributes = extractKeysFromFunctionArgs(renderFunction.toString())\n    console.log(renderFunction)\n    const {type }= renderFunction({} as P)\n    const tagName = \"agc-\" + type\n\n\n      if (!customElements.get(tagName)) {\n    register(renderFunction, tagName, observedAttributes, { shadow: true, styles: sheet });\n      }\n  }\n\n  return renderFunction(props)\n\n  };\n}\n\n\ninitializeComponents(h, createComponent)\n","import { h, cloneElement, render, hydrate } from 'preact';\n\nexport default function register(Component, tagName, propNames, options) {\n\n  console.log(\"register options: \", options)\n\tfunction PreactElement() {\n\t\tconst inst = /** @type {PreactCustomElement} */ (\n\t\t\tReflect.construct(HTMLElement, [], PreactElement)\n\t\t);\n\t\tinst._vdomComponent = Component;\n\t\tinst._root =\n\t\t\toptions && options.shadow\n\t\t\t\t? inst.attachShadow({ mode: options.mode || 'open' })\n\t\t\t\t: inst;\n\n        console.log(\"register\", options.styles)\n        console.log(\"register shadow\", inst._root instanceof ShadowRoot)\n\n        if (options.styles && inst._root instanceof ShadowRoot) {\n                inst._root.adoptedStyleSheets = [options.styles];\n        }\n\n\t\treturn inst;\n\t}\n\tPreactElement.prototype = Object.create(HTMLElement.prototype);\n\tPreactElement.prototype.constructor = PreactElement;\n\tPreactElement.prototype.connectedCallback = connectedCallback;\n\tPreactElement.prototype.attributeChangedCallback = attributeChangedCallback;\n\tPreactElement.prototype.disconnectedCallback = disconnectedCallback;\n\n\t/**\n\t * @type {string[]}\n\t */\n\tpropNames =\n\t\tpropNames ||\n\t\tComponent.observedAttributes ||\n\t\tObject.keys(Component.propTypes || {});\n\tPreactElement.observedAttributes = propNames;\n\n\t// Keep DOM properties and Preact props in sync\n\tpropNames.forEach((name) => {\n\t\tObject.defineProperty(PreactElement.prototype, name, {\n\t\t\tget() {\n\t\t\t\treturn this._vdom.props[name];\n\t\t\t},\n\t\t\tset(v) {\n\t\t\t\tif (this._vdom) {\n\t\t\t\t\tthis.attributeChangedCallback(name, null, v);\n\t\t\t\t} else {\n\t\t\t\t\tif (!this._props) this._props = {};\n\t\t\t\t\tthis._props[name] = v;\n\t\t\t\t\tthis.connectedCallback();\n\t\t\t\t}\n\n\t\t\t\t// Reflect property changes to attributes if the value is a primitive\n\t\t\t\tconst type = typeof v;\n\t\t\t\tif (\n\t\t\t\t\tv == null ||\n\t\t\t\t\ttype === 'string' ||\n\t\t\t\t\ttype === 'boolean' ||\n\t\t\t\t\ttype === 'number'\n\t\t\t\t) {\n\t\t\t\t\tthis.setAttribute(name, v);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t});\n\n\treturn customElements.define(\n\t\ttagName || Component.tagName || Component.displayName || Component.name,\n\t\tPreactElement\n\t);\n}\n\nfunction ContextProvider(props) {\n\tthis.getChildContext = () => props.context;\n\t// eslint-disable-next-line no-unused-vars\n\tconst { context, children, ...rest } = props;\n\treturn cloneElement(children, rest);\n}\n\n/**\n * @this {PreactCustomElement}\n */\nfunction connectedCallback() {\n\t// Obtain a reference to the previous context by pinging the nearest\n\t// higher up node that was rendered with Preact. If one Preact component\n\t// higher up receives our ping, it will set the `detail` property of\n\t// our custom event. This works because events are dispatched\n\t// synchronously.\n\tconst event = new CustomEvent('_preact', {\n\t\tdetail: {},\n\t\tbubbles: true,\n\t\tcancelable: true,\n\t});\n\tthis.dispatchEvent(event);\n\tconst context = event.detail.context;\n\n\tthis._vdom = h(\n\t\tContextProvider,\n\t\t{ ...this._props, context },\n\t\ttoVdom(this, this._vdomComponent)\n\t);\n\t(this.hasAttribute('hydrate') ? hydrate : render)(this._vdom, this._root);\n}\n\n/**\n * Camel-cases a string\n * @param {string} str The string to transform to camelCase\n * @returns camel case version of the string\n */\nfunction toCamelCase(str) {\n\treturn str.replace(/-(\\w)/g, (_, c) => (c ? c.toUpperCase() : ''));\n}\n\n/**\n * Changed whenver an attribute of the HTML element changed\n * @this {PreactCustomElement}\n * @param {string} name The attribute name\n * @param {unknown} oldValue The old value or undefined\n * @param {unknown} newValue The new value\n */\nfunction attributeChangedCallback(name, oldValue, newValue) {\n\tif (!this._vdom) return;\n\t// Attributes use `null` as an empty value whereas `undefined` is more\n\t// common in pure JS components, especially with default parameters.\n\t// When calling `node.removeAttribute()` we'll receive `null` as the new\n\t// value. See issue #50.\n\tnewValue = newValue == null ? undefined : newValue;\n\tconst props = {};\n\tprops[name] = newValue;\n\tprops[toCamelCase(name)] = newValue;\n\tthis._vdom = cloneElement(this._vdom, props);\n\trender(this._vdom, this._root);\n}\n\n/**\n * @this {PreactCustomElement}\n */\nfunction disconnectedCallback() {\n\trender((this._vdom = null), this._root);\n}\n\n/**\n * Pass an event listener to each `<slot>` that \"forwards\" the current\n * context value to the rendered child. The child will trigger a custom\n * event, where will add the context value to. Because events work\n * synchronously, the child can immediately pull of the value right\n * after having fired the event.\n */\nfunction Slot(props, context) {\n\tconst ref = (r) => {\n\t\tif (!r) {\n\t\t\tthis.ref.removeEventListener('_preact', this._listener);\n\t\t} else {\n\t\t\tthis.ref = r;\n\t\t\tif (!this._listener) {\n\t\t\t\tthis._listener = (event) => {\n\t\t\t\t\tevent.stopPropagation();\n\t\t\t\t\tevent.detail.context = context;\n\t\t\t\t};\n\t\t\t\tr.addEventListener('_preact', this._listener);\n\t\t\t}\n\t\t}\n\t};\n\treturn h('slot', { ...props, ref });\n}\n\nfunction toVdom(element, nodeName) {\n\tif (element.nodeType === 3) return element.data;\n\tif (element.nodeType !== 1) return null;\n\tlet children = [],\n\t\tprops = {},\n\t\ti = 0,\n\t\ta = element.attributes,\n\t\tcn = element.childNodes;\n\tfor (i = a.length; i--; ) {\n\t\tif (a[i].name !== 'slot') {\n\t\t\tprops[a[i].name] = a[i].value;\n\t\t\tprops[toCamelCase(a[i].name)] = a[i].value;\n\t\t}\n\t}\n\n\tfor (i = cn.length; i--; ) {\n\t\tconst vnode = toVdom(cn[i], null);\n\t\t// Move slots correctly\n\t\tconst name = cn[i].slot;\n\t\tif (name) {\n\t\t\tprops[name] = h(Slot, { name }, vnode);\n\t\t} else {\n\t\t\tchildren[i] = vnode;\n\t\t}\n\t}\n\n\t// Only wrap the topmost node with a slot\n\tconst wrappedChildren = nodeName ? h(Slot, null, children) : children;\n\treturn h(nodeName || element.nodeName.toLowerCase(), props, wrappedChildren);\n}"],"mappings":"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","names":["import_preact"]}